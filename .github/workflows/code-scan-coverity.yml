name: "code_scan_Coverity"

on:
  # trigger when code changes
  push:
    branches: [main]
    paths:
      - "src/**"
      - .github/workflows/code-scan-coverity.yml

permissions: # added using https://github.com/step-security/secure-workflows
  contents: read

env:
  APPMESH_VERSION: "2.1.2"

jobs:
  coverity-cpp-code-scan:
    runs-on: ubuntu-latest
    container: laoshanxi/appmesh:build_ubuntu22

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde # v2.9.1
        with:
          egress-policy: audit # TODO: change to 'egress-policy: block' after couple of runs

      - name: Checkout Github code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Cmake init with Debug mode
        run: |
          mkdir build
          cd build
          export OPENSSL_ROOT_DIR=/usr/local/ssl
          cmake -DCMAKE_BUILD_TYPE=Debug ..

      # https://github.com/vapier/coverity-scan-action
      - name: Coverity scan
        uses: vapier/coverity-scan-action@2068473c7bdf8c2fb984a6a40ae76ee7facd7a85 # v1.8.0
        with:
          project: laoshanxi%2Fapp-mesh
          working-directory: build
          token: ${{ secrets.COVERITY_SCAN_TOKEN }}
          email: 178029200@qq.com
          version: ${{ env.APPMESH_VERSION }}
