name: Build on macOS

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/build-macos.yaml"
      - "src/**"
      - "script/**"
env:
  APPMESH_VERSION: "2.1.2"

jobs:
  build:
    strategy:
      matrix:
        os: [macos-14, macos-15]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout Github code
        uses: actions/checkout@v4

      - name: Setup Homebrew and Install Dependencies
        run: |
          echo "Updating Homebrew..."
          brew update

          echo "Installing required packages..."
          brew install wget cmake go openssl@3 boost log4cpp openldap cryptopp oath-toolkit yaml-cpp nlohmann-json msgpack-cxx

          echo "Verifying installed packages..."
          brew list

      - name: Configure Build Environment
        run: |
          bash script/setup_build_env/autogen.sh.mac.sh

      - name: Build project
        if: always()
        run: |
          echo "Creating build directory..."
          mkdir -p build && cd build

          echo "Running CMake configuration..."
          cmake ..

          echo "Building the project..."
          make -j"$(nproc)"
          make pack

          echo "Testing the project..."
          sudo mkdir -p /opt/appmesh
          sudo tar zxvf appmesh_*_arm64.gz -C /opt/appmesh
          sudo bash /opt/appmesh/script/setup.sh
          sudo bash /opt/appmesh/script/appmesh.initd.sh start
          sleep 2
          cat /opt/appmesh/work/server.log
          #appc ls
          #appc resource

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          name: "SDK & Security enhancement"
          tag_name: ${{ env.APPMESH_VERSION }}
          fail_on_unmatched_files: false
          token: ${{ secrets.PUBLISH_RELEASE }}
          files: |
            build/appmesh_*.gz
